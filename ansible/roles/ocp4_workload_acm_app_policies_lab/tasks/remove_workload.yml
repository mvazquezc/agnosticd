---
# Implement your Workload removal tasks here

# 1. Ensure we're connected to the cluster
# 2. Make a temporary dir for cloning the deploy repo
# 3. Clone the deploy repository
# 4. Run the uninstall script


- name: Ensure there is connectivity to OCP cluster as system:admin
  command: oc whoami
  register: whoami
  changed_when: false

- name: Fail if not system:admin
  fail:
    msg: "Not connected to OCP as system:admin"
  when: whoami.stdout != "system:admin"


- name: Ensure required templates are present
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: 0666
  loop:
    - { src: ./templates/subscription.j2, dest: /tmp/subscription.yaml }
    - { src: ./templates/multiClusterHub.j2, dest: /tmp/multiClusterHub.yaml }
    - { src: ./templates/operatorGroup.j2, dest: /tmp/operatorGroup.yaml }

- name: Ensure RHACM MultiClusterHub is absent
  shell: oc -n "{{ ocp4_workload_acm_app_policies_lab_acm_project }}" delete -f /tmp/multiClusterHub.yaml

- name: Ensure RHACM Subscription is absent
  shell: oc -n "{{ ocp4_workload_acm_app_policies_lab_acm_project }}" delete -f /tmp/subscription.yaml

- name: Ensure RHACM OperatorGroup is absent
  shell: oc -n "{{ ocp4_workload_acm_app_policies_lab_acm_project }}" delete -f /tmp/operatorGroup.yaml

- name: Ensure RHACM Namespace is absent
  shell: oc delete namespace "{{ ocp4_workload_acm_app_policies_lab_acm_project }}"

- name: Ensure helper scripts are removed
  file:
    path: "{{ item }}"
    state: absent
  become: true
  loop:
    - /usr/local/bin/wait-for-deployment
    - /usr/local/bin/verify-contexts

# Leave this as the last task in the playbook.
- name: remove_workload tasks complete
  debug:
    msg: "Remove Workload tasks completed successfully."
  when: not silent|bool
